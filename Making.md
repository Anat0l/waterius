
Вопросы по изготовлению задавайте тут: [issues](https://github.com/dontsovcmc/waterius/issues)

## Компоненты

| # | Наименование | Кол-во | Примечание | Магазин |   
| ---- | ---- | ---- | ---- | ---- |
| 1 | Atmega Attiny85-20SU | 1 | Attiny85V тоже ок | [chipdip](https://www.chipdip.ru/product/attiny85-20su) |
| 2 | Керам. конденсатор SMD 0805 16В 0.1 мкФ | 2 |  | [chipdip](https://www.chipdip.ru/product/grm21br71h104k) |
| 3 | Керам. конденсатор SMD 0805 16В 1 мкФ  | 2 | для стабилизатора. можно любой > 1 мкФ | [chipdip](https://www.chipdip.ru/product/grm21br71c105k) |
| 4 | Резистор SMD 0805 3.3 кОм | 8 | Для i2c 2-6кОм, для остальных до 10кОм | [chipdip](https://www.chipdip.ru/product0/9000079498) |
| 5 | Резистор SMD 0805 300 Ом | 2 | Для светодиода >250Ом, для земли любой до 500Ом | [chipdip](https://www.chipdip.ru/product0/9000079473) |
| 6 | Светодиод 3В | 1 | Любой. Беру GNL-3014PGC 8000мКд, очень яркий. | [chipdip](https://www.chipdip.ru/product/gnl-3014pgc) |
| 7 | Разъем гнездо на плату 2.54мм PBD-8 | 1 | Для ESP8266-01 | [chipdip](https://www.chipdip.ru/product/pbd-8) |
| 8 | Кнопка тактовая угловая 7мм KLS7-TS6606-7.0-180 (TC-0206) | 1 | Лучше угловая длиной от 7мм. Прямая кнопка потребует дырку в сдвижной крышке, что нeудобно | [chipdip](https://www.chipdip.ru/product/kls7-ts6606-7.0-180-tc-0206) |
| 9 | Пин на плату | 1 | Любой для прошивки | [chipdip](https://www.chipdip.ru/product/tyco-826629-2) |
| 10 | ESP8266-01 | 1 | ESP8266-01s потребляют 0мкА, а ESP8266-01 около 10мкА | [yandex](https://yandex.ru/search/?text=ESP8266-01&lr=213) |
| 11 | Закрытый батарейный отсек 4xAA | 1 | У ЧипДип KLS5-812-B, качество не очень. | [chipdip](https://www.chipdip.ru/product/fc1-5230) |
| 12 | Стабилизатор MCP1700T-3002E-TT | 1 |  | [terraelectronica](https://www.terraelectronica.ru/product/241237) |
| 13 | Разъем под кабель на плату 4 контакта 2.54мм | 1 | Без винтов: DG141V-2.54-04P-14-00AH | [terraelectronica](https://www.terraelectronica.ru/product/1072180) |
| 14 | [Плата](https://github.com/dontsovcmc/waterius/raw/master/Board/waterius-factory-board.jpg) | 1 | или [ЛУТ](https://github.com/dontsovcmc/ImpCounter/raw/master/Board/waterius-homemade-board.png) | пишите |
+ программаторы для Attiny85 и ESP8266-01

## Схема

Электрическая схема: 
<img src="https://github.com/dontsovcmc/waterius/blob/master/Board/scheme.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/Board/scheme.png" width="640"/> 


Вот так выглядит заводская плата с напаенными элеметами:

<img src="https://github.com/dontsovcmc/waterius/raw/master/Board/waterius-factory-board.jpg" data-canonical-src="https://github.com/dontsovcmc/waterius/raw/master/Board/waterius-factory-board.jpg" width="400"/>

По фотографии удобно паять.

Примечание: На плате перепутаны обозначения C2 и R4! На фото элементы припаяны правильно.

# Изготовление
Итак, все компоненты, плата и программаторы у вас есть. 
1. Пайку лучше начинать с резисторов, конденсаторов. Далее припаять разъёмы, кнопку, светодиод и пин. В последнюю очередь припаять attiny85.
2. Протестируйте плату (см. Тестирование ниже).
3. Прошейте attiny85 через разъём подключения ESP. Не забудьте про пин ресет и подачу питания. Прошейте ESP с помощью 3.3в usb-ttl.
4. Подготовьте корпус Вотериуса и установите в него плату.
5. Можно пользоваться! =)

### Примечания

Доработка ESP8266-01:
1. Удалить оба сведидода. Я это делаю разрезанием дорожки ножом между светодиодом и резистором.
2. Снять пластиковую основу контактов и откусить 2мм от каждого пина, чтобы микроконтроллер влез по высоте в корпус.

Доработка ESP8266-01s:
1. [Удалить резистор](https://github.com/dontsovcmc/waterius/raw/master/files/esp8266-01s_mod.jpg). 
2. Удалить светодиод Wi-Fi.
3. Снять пластиковую основу контактов и откусить 2мм от каждого пина, чтобы микроконтроллер влез по высоте в корпус.

### Изготовление корпуса

1. Дырка под разъем DG141V-2.54-04P-14-00AH в крышке батарейного блока.
2. 2 отверстия под кнопку и светодиод 3мм. 

Будьте аккуратны при разрезании пластикового корпуса. Лучше всего это делать бормашникой или дрелью. 

### Тестирование

Сначала протестируйте плату без ESP.
1. Проверьте отсутствие коротких замыканий на плате.
2. Ток потребления с непрошитой Attiny85 со стабилизатором должен быть 300-600мкА
3. Ток потребления с прошитой Attiny85 со стабилизатором должен быть 7-11мкА. 
Если он выше, промойте плату от флюса! Один раз мне пришлось отпаивать стабилизатор, мыть и припаивать назад - после высыхания спирта ток возвращался к 120мкА. 
4. Вы можете проверить на ардуине работу Attiny85 по i2c и подсчет импульсов. Для этого загрузите прошивку с TEST_WATERIUS, а также возьмите обычную Ардуино, загрузив в нее проект tests\test_attiny85 (поменяйте platformio.ini в соответствии с используемой платой). Подключите A1, A0 к входам счетчика, а A4, A5 к линии i2c. Раз в 10 секунд в консоли вы должны видеть обмен и увеличение кол-ва импульсов. Baudrate: 115200 
Ток потребления тестового скетча Attiny85 со стабилизатором будет ~18 мкА

5. Ток потребления Вотериуса с только что прошитой ESP, которая не разу не была включена ~2мА.
Ток потребления Вотериуса с ESP после выполнения настройки и корректного подключения к точке доступа 15-25 мкА.

6. Если Вотериус при настройке не может подключиться к точке доступа (светодиод горит больше 10 сек после нажатия ОК), зайдите еще раз на его веб страницу (нужно опять ввести SSID, password). Чтобы выключить точку доступа - нажмите кнопку ~5сек и отпустите.

7. Посмотреть лог работы ESP можно подключив USB-TTL переходник к выводу LOG (TX pin ESP). На плате есть дырка под пин. (115200 8N1)

### Исполнение без стабилизатора

Убираем 2 конденсатора на 1 мкФ. Оставляем один 10мкФ или меньший по питанию.
Подключать две батарейки! Лучше всего литиевые 1.5В (~200руб/шт).

Если 2 батарейки не литиевые, то для увеличения времени работы устройства, необходимо купить Attiny85V (для пониженного напряжения), тогда счетчик должен работать вплоть до 2.5В. Обычная Attiny85 работает до 2.7В. 
Напряжение питания вы увидите в blynk на виртуальном пине V2 (не калиброванное).

### Разработка

При разработке прошивки для attiny85 удобно использовать лог на 3 пине. Параметры: 9600 8N1. 
Из-за не точной калибровки Attiny85 (до 10%) не все USB-TTL будут "слышать" лог =(.

Вид сверху на плату, разъем под счетчики сверху:

| GND | LOG (D3) | GND |  D4 | 
| ---- | ---- | ---- | ---- |
| низ |

Плата ESP внизу разъема.
