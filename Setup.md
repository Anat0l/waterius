
# Установка счётчика
Для работы Вотериуса нужно приложение Blynk.cc на телефоне, а также настроить само устройство.

## Настройка приложения Blynk
- [Установите приложение Blynk на телефон](https://www.blynk.cc/getting-started).
- Авторизируйтесь в нём
- Нажмите на значок QR кода вверху, чтобы скопировать проект waterius (Андроид)
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step01.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step01.png" width="200"/> 
- Наводим камеру телефона на QR код:
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/qr.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/qr.png" width="200"/> 
- Будет создан клон проекта. Теперь надо узнать уникальный ключ для отправки данных в проект.
- Нажимаем "старт", затем "стоп":
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step02.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step02.png" width="280"/> 
- Нажимаем на "гайку" для настройки:
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step03.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step03.png" width="280"/> 
- Нажимаем "Скопировать код в буфер телефона" (удобно, если с телефона будем заходить на waterius) или "отправить код по эл. почте" (удобно при настройке с ноутбука)
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step04.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step04.png" width="280"/> 

## Установка Вотериуса
- скопируйте Токен из Blynk в буфер обмена, если используете это приложение
- подключите счётчики воды к разъемам Wi-fi счётчика
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/input.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/input.png" width="280"/> 
Горячую воду подключаем в контакты 1-2, холодную в 3-4 (нумерация слева направо).
Обеспечьте неподвижность проводов.

- установите батарейки
- нажмите кнопку >4сек на корпусе - включится Веб сервер для настройки - загорится светодиод и будет мерцать.
- Для настройки: найдите телефоном Wi-Fi точку доступа Waterius_0.7, подключитесь к ней.
- Телефон сразу откроет приветственную страницу подключения. Если нет, то в браузере наберите http://192.168.4.1
- Нажмите Настроить WiFi. Через пару секунд откроется страница настроек.

### Настройки 

<img src="https://github.com/dontsovcmc/waterius/blob/master/files/wifi_setup.jpg" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/wifi_setup.jpg"/> 

- SSID: имя сети домашнего Wi-Fi
- password: пароль домашнего Wi-Fi

SSID и password надо вводить каждый раз при входе в режим настройки!

#### Настройки waterius.ru или своего сервера
- [сервер, куда будет отправлет JSON](https://github.com/dontsovcmc/waterius/blob/master/Export.md). Если не заполнен, отправки не будет. https://cloud.waterius.ru
- поле JSON "email". для waterius.ru введите электронную почту указанную для доступа в личный кабинет
- поле JSON "token". оставьте поле пустым. ключ сгенерируется автоматически.

#### Настройки Blynk
- сервер Blynk. blynk-cloud.com
- ключ Blynk. Вставьте из буфера обмена ключ из приложения Blynk. Если поле пустое, отправки нет
- адрес эл. почты. Если поле заполнено + есть виджет "почта" в проекте, Blynk будет отправлять письмо
- заголовок письма от Blynk
- текст письма от Blynk

#### Настройки счётчиков
- В поле 0,00 введите текущее показание счетчика горячей воды с двумя знаками после запятой
- В поле 0,10 введите текущее показание счетчика холодной воды с двумя знаками после запятой
- Поле 10 оставьте, если ваш счетчик выдает 1 импульс на 10 л воды. Если импульс каждый литр, то измените на 1.

- нажмите Сохранить

- убедитесь, что светодиод погас через 3-10 секунд, что говорит об успешном подключении к Wi-Fi. Если светодиод не погас, то заново откройте 192.168.4.1 и введите корректные настройки Wi-Fi сети
(внимание: пока не исправлена ошибка https://github.com/dontsovcmc/waterius/issues/49 каждый раз нужно менять сеть/пароль или внесите изменения в фреймворк arduino_espressif8266 вручную)

#### Завершение настройки, проверка связи с серверами
- Нажмите в приложении Blynk треугольник (play).
- нажмите на кнопку коротким нажатием (меньше 2сек) - Вотериус пришлет введенные вами показания и вы увидите их в Blynk
- далее Вотериус будет слать показания примерно раз в сутки

### Параметры Blynk: 

Приложение Blynk должно быть запущено (в углу квадрат "стоп").

В Blynk данные приходят на виртуальные пины Virtual_pin.

| пин | данные | размерность | примечание |   
| ---- | ---- | ---- | ---- |
| V0 | показания счетчика 0 | м3 |  |
| V1 | показания счетчика 1 | м3 |  |
| V2 | напряжение питания | В | после стабилизатора. около 3В из-за погрешности attiny85 |
| V3 | суточное потребление 0 | л |  |
| V4 | суточное потребление 1 | л |  |
| V5 | кол-во перезагрузок |  |  |


#### Подключение нескольких Вотериусов

Для того, чтобы несколько Вотериусов отсылало в один проект данные, надо добавить в меню новое устройство: Devices - New device. Выбрать Wifi, ESP8266.
Далее добавить виджеты и выбрать источник: устройство и пин


#### Электронное письмо

Для отправки показаний по эл. почте необходимо ввести адрес в настройках Вотериуса, а также добавить виджет e-mail в Blynk. 
Возможно при нажатии на виджет необходимо ввести свою электронную почту.

