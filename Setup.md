
# Установка и настройка

## Подключение счётчиков
- подключите счётчики воды к разъемам Wi-fi счётчика
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/input.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/input.png" width="280"/> 
Горячую воду подключаем в контакты 1-2, холодную в 3-4 (нумерация слева направо).
Обеспечьте неподвижность проводов.
Убедитесь, что холодной водой никто не пользуется.

## Настройка приложения Blynk
<b>Если вы хотите передавать показания в приложение Blynk</b>
- [Установите приложение Blynk на телефон](https://www.blynk.cc/getting-started).
- Авторизируйтесь в нём
- Нажмите на значок QR кода вверху, чтобы скопировать проект waterius (Андроид)
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step01.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step01.png" width="200"/> 
- Наводим камеру телефона на QR код:
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/qr.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/qr.png" width="200"/> 
- Будет создан клон проекта. Теперь надо узнать уникальный ключ для отправки данных в проект.
- Нажимаем "старт", затем "стоп":
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step02.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step02.png" width="280"/> 
- Нажимаем на "гайку" для настройки:
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step03.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step03.png" width="280"/> 
- Нажимаем "Скопировать код в буфер телефона" (удобно, если с телефона будем заходить на waterius) или "отправить код по эл. почте" (удобно при настройке с ноутбука)
<img src="https://github.com/dontsovcmc/waterius/blob/master/files/step04.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/step04.png" width="280"/> 


## Настройка Ватериуса
- установите батарейки
- нажмите кнопку >4сек на корпусе И отпустите - включится Веб сервер для настройки - загорится светодиод и будет мерцать.
- найдите телефоном Wi-Fi точку доступа Waterius_0.8.2, подключитесь к ней.
- телефон откроет приветственную страницу подключения. Если нет, то наберите в браузере http://192.168.4.1
- нажмите Настроить WiFi. Через пару секунд откроется страница настроек.

### Настройки 

<img src="https://github.com/dontsovcmc/waterius/blob/master/files/wifi_setup.jpg" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/files/wifi_setup.jpg"/> 

- SSID: имя сети домашнего Wi-Fi
- password: пароль домашнего Wi-Fi

<b>Примечение:</b> SSID и password надо вводить каждый раз при входе в режим настройки!

#### Настройки waterius.ru или своего сервера
- поле JSON "email". для waterius.ru введите электронную почту указанную для доступа в личный кабинет.

- поле JSON "token". оставьте поле пустым. ключ сгенерируется автоматически.
- [сервер, куда будет отправлет JSON](https://github.com/dontsovcmc/waterius/blob/master/Export.md). Если не заполнен, отправки не будет. https://cloud.waterius.ru

#### Настройки Blynk
- сервер Blynk. blynk-cloud.com
- ключ Blynk. Вставьте из буфера обмена ключ из приложения Blynk. Если поле пустое, отправки нет
- адрес эл. почты. Если поле заполнено + есть виджет "почта" в проекте, Blynk будет отправлять письмо каждые сутки
- заголовок письма от Blynk
- текст письма от Blynk

Для отправки показаний по эл. почте необходимо добавить виджет e-mail в Blynk. Возможно при нажатии на виджет необходимо ввести свою электронную почту.

Приложение Blynk должно быть запущено (в углу квадрат "стоп").

В Blynk данные приходят на виртуальные пины Virtual_pin.
| пин | данные | размерность | примечание |   
| ---- | ---- | ---- | ---- |
| V0 | показания счетчика 0 | м3 |  |
| V1 | показания счетчика 1 | м3 |  |
| V2 | напряжение питания | В | после стабилизатора. около 3В из-за погрешности attiny85 |
| V3 | суточное потребление 0 | л |  |
| V4 | суточное потребление 1 | л |  |
| V5 | кол-во перезагрузок |  |  |

<b>Подключение нескольких Вотериусов</b>
Для того, чтобы несколько Вотериусов отсылало в один проект данные, надо добавить в меню новое устройство: Devices - New device. Выбрать Wifi, ESP8266. Далее добавить виджеты и выбрать источник: устройство и пин

#### Настройки MQTT
[Описание](https://github.com/dontsovcmc/waterius/blob/master/Mqtt.md)

### Настройки счётчиков
- Спустите унитаз
- Надпись "не подключен" должна смениться на "подключен" (Ватериус видит импульсы от счетчика. Если не так, то спустите воду ещё пару раз, чтобы слить больше 10 литров. Если надпись не сменилась - проверьте подключение проводов.)
- Введите показания холодной воды.
1. Введите дробное число кубометров (обычно это черные цифры на счетчике). После точки и запятой введите литры.
- Откройте горячую воду, чтобы надпись сменилась на "подключен".
- Введите показания горячей воды.
- Множитель (кол-во литров на импульс) определяется автоматически:
1. Настраивать надо каждый раз при включении настройки
2. Множитель определяется по Входу №2 (холодная вода)
3. Множитель равен 10, если кол-во импульсов пришедших от открытия Окна "Настройка", до нажатия кнопки "Сохранить" меньше либо равно 3.
4. Множитель равен 1, если 4 и выше.
5. Множитель для горячей и холодной воды одинаковый.
6. В настройке предлагается спустить унитаз. Объём воды в нем обычно 4 литра.
Таким образом, вы спускаете унитаз и Ватериус видит, если пришло больше 3-х импульсов, то у вас счетчик выдает 1 импульс на каждый литр. Если пришел 1 импульс, то 1 импульс на 10 литров.

- нажмите Сохранить

- убедитесь, что светодиод погас через 3-10 секунд, что говорит об успешном подключении к Wi-Fi. Если светодиод не погас, то заново откройте 192.168.4.1 и введите корректные настройки Wi-Fi сети
(внимание: пока не исправлена ошибка https://github.com/dontsovcmc/waterius/issues/49 каждый раз нужно менять сеть/пароль или внесите изменения в фреймворк arduino_espressif8266 вручную)

#### Завершение настройки, проверка связи с серверами
- нажмите на кнопку коротким нажатием (меньше 2сек) - Вотериус пришлет введенные вами показания и вы увидите их в Blynk, MQTT и сервере cloud.waterius.ru или своем.
- далее Вотериус будет слать показания <b>примерно</b> раз в сутки



